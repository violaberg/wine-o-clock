{% extends "base.html" %}
{% load static %}

{% block content %}
<div class="container">
  <div class="row">
    <div class="col-md-12 col-lg-10 text-center mx-auto">
      <img src="{% static 'images/reviews.jpg' %}" class="img-fluid"
        alt="Wine pouring in glass sitting on wooden table in sunshine">
    </div>
  </div>
</div>
<div class="container">
  <header class="text-center mt-4">
    <h1 class="font-parisienne custom-gold">Book a Tour</h1>
  </header>
  <div class="row mt-2">
    <div class="col-md-12 text-center">
      <p class="font-montserrat custom-white">
        Embark on a journey through the heart of our wine sanctuary with our exclusive cellar tour experience, immerse
        yourself in the rich history of our vineyards, witness the meticulous craftsmanship behind each bottle, and
        indulge in the captivating stories that make each sip extraordinary. Our knowledgeable guides will lead you
        through the hidden gems of our cellar, unveiling the artistry and passion that goes into crafting our
        exceptional wines. Whether you're a wine enthusiast or a casual connoisseur, a wine cellar tour with us promises
        an unforgettable blend of education, taste, and ambiance. Book your tour now through <a
          class="link font-parisienne custom-gold" href="{% url 'contact' %}">Contact Us form</a> and elevate your wine
        experience to new heights!
      </p>
    </div>
  </div>
</div>
<hr class="custom-white">
<!--Reviews-->
<div class="row text-center mt-4">
  <div class="col-12 col-md-8 col-lg-6 text-center mx-auto">
    <h1 class="font-parisienne custom-gold text-center">Customer Reviews</h1>
    <!--Display Existing Reviews-->
    {% for review in reviews %}
    <div class="user-review text-center my-3">
      {% if review.image %}
      <img class="img-fluid border-0 scale" src="{{ review.image.url }}" alt="Review Image">
      {% endif %}
      <p class="font-montserrat custom-gold">by {{ review.author }}</p>
      <span class="font-montserrat custom-gold opacity-50">
        {{ review.timestamp }}
      </span>
      <div class="font-montserrat custom-white p-2" id="review{{ review.id }}">
        {{ review.body }}
      </div>
      {% if user.is_authenticated and review.author == user %}
      <button class="button btn custom-white button-edit btn-edit" data-review_id="{{ review.id }}">Edit</button>
      <button class="button btn custom-white button-delete btn-delete" data-review_id="{{ review.id }}">Delete</button>
      {% endif %}
    </div>
    {% endfor %}

    <!-- Pagination -->
    <div class="row mt-3">
      <div class="col">
        <nav aria-label="Page navigation">
          <ul class="pagination justify-content-center">
            {% if page_obj.has_previous %}
            <li class="page-item">
              <a class="page-link" href="?page={{ page_obj.previous_page_number }}" aria-label="Previous">
                <span aria-hidden="true">&laquo;</span>
              </a>
            </li>
            {% endif %}
            {% for num in page_obj.paginator.page_range %}
            {% if page_obj.number == num %}
            <li class="page-btn page-item active p-3"><span class="page-link">{{ num }}</span></li>
            {% elif num > page_obj.number|add:'-3' and num < page_obj.number|add:'3' %}
            <li class="page-btn page-item px-2"><a class="page-link" href="?page={{ num }}">{{ num }}</a></li>
            {% endif %}
            {% endfor %}
            {% if page_obj.has_next %}
            <li class="page-btn page-item">
              <a class="page-link rounded-0" href="?page={{ page_obj.next_page_number }}" aria-label="Next">
                <span aria-hidden="true">&raquo;</span>
              </a>
            </li>
            {% endif %}
          </ul>
        </nav>
      </div>
    </div>

    <hr class="custom-white">
    <!--Form for new reviews-->
    <h1 class="font-parisienne custom-gold mt-4">Leave a review</h1>
    <p class="font-montserrat custom-white">Writing as: <span
        class="user font-parisienne custom-gold">{{ user.username }}</span></p>
    <div class="new-review col-12 col-md-10 mx-auto p-2">
      {% if user.is_authenticated %}
      <form id="reviewForm" method="post" action="{% url 'reviews' %}" enctype="multipart/form-data">
        {% csrf_token %}
        {{ form|crispy }}
        <button type="submit" class="review-btn button btn custom-white" id="submitReviewButton">Submit Review</button>
      </form>
      {% else %}
      <p class="font-montserrat custom-gold">Please <a class="custom-gold fw-bold" href="{% url 'account_login' %}">log
          in</a> to leave a review</p>
      {% endif %}
    </div>
  </div>
</div>

<!-- Edit review modal -->
<div class="modal fade" id="editReviewModal{{ review.id }}" tabindex="-1"
  aria-labelledby="editReviewModalLabel{{ review.id }}" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="editReviewModalLabel{{ review.id }}">Edit Review</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <form method="post" action="{% url 'edit_review' review.id %}" enctype="multipart/form-data">
        <div class="modal-body">
          {% csrf_token %}
          <div class="mb-3">
            <label for="reviewBody{{ review.id }}" class="form-label">Review</label>
            <textarea class="form-control" id="reviewBody{{ review.id }}" name="body"
              rows="3">{{ review.body }}</textarea>
          </div>
          <div class="mb-3">
            <label for="reviewImage{{ review.id }}" class="form-label">Image</label>
            <input class="form-control" type="file" id="reviewImage{{ review.id }}" name="image">
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-primary">Save changes</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Delete review confirmation modal -->
<div class="modal fade" id="deleteReviewModal{{ review.id }}" tabindex="-1"
  aria-labelledby="deleteReviewModalLabel{{ review.id }}" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="deleteReviewModalLabel{{ review.id }}">Delete Review</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        Are you sure you want to delete this review? This action cannot be undone.
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <form method="post" action="{% url 'delete_review' review.id %}">
          {% csrf_token %}
          <button type="submit" class="btn btn-danger">Delete</button>
        </form>
      </div>
    </div>
  </div>
</div>
{% endblock content %}

{% block extras %}
<script src="{% static 'js/reviews.js' %}"></script>
{% endblock %}